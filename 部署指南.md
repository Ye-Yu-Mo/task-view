# TaskView Docker 部署指南

本指南将帮助您使用Docker部署TaskView任务看板管理系统。

## 📋 前置要求

- Docker 25.0 或更高版本  
- Docker Compose v2.20 或更高版本
- 4GB+ 可用内存（用于构建）
- 2GB+ 磁盘空间

## 🚀 快速开始

### 方式一：使用 Docker Compose（推荐）

1. **克隆项目**
```bash
git clone <repository-url>
cd task-view
```

2. **启动应用**
```bash
# 构建并启动
docker-compose up -d --build

# 或者仅启动（如果已构建）
docker-compose up -d
```

3. **访问应用**
- 打开浏览器访问: `http://localhost:3000`
- 健康检查: `http://localhost:3000/health`
- API接口: `http://localhost:3000/api`

### 方式二：使用 Docker 命令

1. **构建镜像**
```bash
docker build -t taskview:latest .
```

2. **运行容器**
```bash
docker run -d \
  --name taskview-app \
  -p 3000:80 \
  -v taskview-data:/app/data \
  -e JWT_SECRET="your-secure-jwt-secret" \
  taskview:latest
```

## 📁 数据持久化

应用数据（包括SQLite数据库）存储在Docker卷中：

- `taskview-data`: 存储应用数据库文件
- `taskview-logs`: 存储Nginx访问日志

### 数据备份

```bash
# 备份数据
docker run --rm -v taskview-data:/data -v $(pwd):/backup alpine tar czf /backup/taskview-data-backup.tar.gz /data

# 恢复数据  
docker run --rm -v taskview-data:/data -v $(pwd):/backup alpine tar xzf /backup/taskview-data-backup.tar.gz -C /
```

## ⚙️ 环境配置

在 `docker-compose.yml` 或运行时设置以下环境变量：

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `JWT_SECRET` | 自动生成 | JWT签名密钥（生产环境必须修改） |
| `RUST_LOG` | info | 日志级别 (trace, debug, info, warn, error) |
| `TZ` | Asia/Shanghai | 时区设置 |

### 生产环境配置示例

```yaml
environment:
  - JWT_SECRET=your-very-secure-32-characters-secret
  - RUST_LOG=warn
  - TZ=Asia/Shanghai
```

## 🔧 管理命令

### 查看日志
```bash
# 查看应用日志
docker-compose logs -f taskview

# 查看构建日志
docker-compose logs --no-color taskview > build.log
```

### 重启服务
```bash
# 重启服务
docker-compose restart taskview

# 重新构建并重启
docker-compose up -d --build
```

### 停止服务
```bash
# 停止服务
docker-compose stop

# 停止并删除容器（保留数据）
docker-compose down

# 删除所有内容（包括数据）
docker-compose down -v
```

## 🌐 反向代理配置

如需使用域名访问，可配置Nginx反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 📊 监控和健康检查

### 健康检查端点
- `/health` - 应用健康状态
- `/api/health` - 后端API健康状态

### 容器状态监控
```bash
# 查看容器状态
docker-compose ps

# 查看资源使用情况
docker stats taskview-app
```

## 🔒 安全建议

1. **修改默认JWT密钥**
   ```bash
   # 生成安全的JWT密钥
   openssl rand -base64 32
   ```

2. **使用HTTPS**
   - 配置SSL证书
   - 使用Let's Encrypt等免费证书

3. **防火墙配置**
   - 仅开放必要端口
   - 限制访问来源IP

4. **定期备份**
   - 设置自动备份计划
   - 测试恢复流程

## 🐛 故障排除

### 常见问题

1. **容器无法启动**
   ```bash
   # 查看详细日志
   docker-compose logs taskview
   
   # 检查端口占用
   lsof -i :3000
   ```

2. **前端无法访问后端API**
   ```bash
   # 进入容器检查
   docker-compose exec taskview sh
   
   # 测试后端连接
   wget -O- http://127.0.0.1:20000/api/health
   ```

3. **数据丢失**
   ```bash
   # 检查数据卷
   docker volume ls
   docker volume inspect taskview-data
   ```

### 重置应用数据
```bash
# 警告：这将删除所有数据！
docker-compose down -v
docker volume rm taskview-data taskview-logs
docker-compose up -d --build
```

## 📝 更新应用

1. **停止当前服务**
   ```bash
   docker-compose down
   ```

2. **拉取最新代码**
   ```bash
   git pull origin main
   ```

3. **重新构建并启动**
   ```bash
   docker-compose up -d --build
   ```

## 💡 性能优化

1. **构建缓存优化**
   ```bash
   # 使用BuildKit加速构建
   DOCKER_BUILDKIT=1 docker-compose build
   ```

2. **资源限制**
   ```yaml
   services:
     taskview:
       deploy:
         resources:
           limits:
             memory: 512M
             cpus: '0.5'
   ```

---

如遇到其他问题，请查看项目文档或提交Issue。